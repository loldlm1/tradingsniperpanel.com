<!DOCTYPE html>
<html lang="<%= I18n.locale %>">
  <head>
    <meta charset="utf-8">
    <title><%= content_for(:title) || "#{t('app.name')} Dashboard" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "mosaic/css/vendors/flatpickr.min", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "mosaic/style", "data-turbo-track": "reload" %>
    <%= yield :head %>
  </head>
  <body
    class="<%= content_for?(:body_class) ? yield(:body_class) : "font-inter antialiased bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-400" %>"
    :class="{ 'sidebar-expanded': sidebarExpanded }"
    x-data="{ sidebarOpen: false, sidebarExpanded: localStorage.getItem('sidebar-expanded') == 'true' }"
    x-init="$watch('sidebarExpanded', value => localStorage.setItem('sidebar-expanded', value))"
  >
    <script>
      if (localStorage.getItem('dark-mode') === 'false' || !('dark-mode' in localStorage)) {
        document.documentElement.classList.remove('dark');
        document.documentElement.style.colorScheme = 'light';
      } else {
        document.documentElement.classList.add('dark');
        document.documentElement.style.colorScheme = 'dark';
      }
      if (localStorage.getItem('sidebar-expanded') == 'true') {
        document.body.classList.add('sidebar-expanded');
      } else {
        document.body.classList.remove('sidebar-expanded');
      }
    </script>

    <div class="flex h-[100dvh] overflow-hidden">
      <div class="min-w-fit">
        <div
          class="fixed inset-0 bg-gray-900/30 z-40 lg:hidden lg:z-auto transition-opacity duration-200"
          :class="sidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'"
          aria-hidden="true"
          x-cloak
        ></div>

        <div
          id="sidebar"
          class="flex flex-col absolute z-40 left-0 top-0 lg:static lg:left-auto lg:top-auto lg:translate-x-0 h-[100dvh] overflow-y-scroll lg:overflow-y-auto no-scrollbar w-64 lg:w-20 lg:sidebar-expanded:!w-64 2xl:!w-64 shrink-0 bg-white dark:bg-gray-800 shadow-xs rounded-r-2xl p-4 transition-all duration-200 ease-in-out"
          :class="sidebarOpen ? 'translate-x-0' : '-translate-x-64'"
          @click.outside="sidebarOpen = false"
          @keydown.escape.window="sidebarOpen = false"
          x-cloak="lg"
        >
          <div class="flex justify-between mb-10 pr-3 sm:px-2">
            <button class="lg:hidden text-gray-500 hover:text-gray-400" @click.stop="sidebarOpen = !sidebarOpen" aria-controls="sidebar" :aria-expanded="sidebarOpen">
              <span class="sr-only">Close sidebar</span>
              <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.7 18.7l1.4-1.4L7.8 13H20v-2H7.8l4.3-4.3-1.4-1.4L4 12z" />
              </svg>
            </button>
            <%= link_to dashboard_path, class: "block", "aria-label": t("app.name") do %>
              <svg class="fill-violet-500" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
                <path d="M31.956 14.8C31.372 6.92 25.08.628 17.2.044V5.76a9.04 9.04 0 0 0 9.04 9.04h5.716ZM14.8 26.24v5.716C6.92 31.372.63 25.08.044 17.2H5.76a9.04 9.04 0 0 1 9.04 9.04Zm11.44-9.04h5.716c-.584 7.88-6.876 14.172-14.756 14.756V26.24a9.04 9.04 0 0 1 9.04-9.04ZM.044 14.8C.63 6.92 6.92.628 14.8.044V5.76a9.04 9.04 0 0 1-9.04 9.04H.044Z" />
              </svg>
            <% end %>
          </div>

          <div class="space-y-8">
            <div>
              <h3 class="text-xs uppercase text-gray-400 dark:text-gray-500 font-semibold pl-3">
                <span class="hidden lg:block lg:sidebar-expanded:hidden 2xl:hidden text-center w-6" aria-hidden="true">•••</span>
                <span class="lg:hidden lg:sidebar-expanded:block 2xl:block"><%= t("nav.dashboard") %></span>
              </h3>
              <ul class="mt-3">
                <li class="pl-4 pr-3 py-2 rounded-lg mb-0.5 last:mb-0 bg-linear-to-r from-violet-500/[0.12] dark:from-violet-500/[0.24] to-violet-500/[0.04]" x-data="{ open: true }">
                  <a class="block text-gray-800 dark:text-gray-100 truncate transition" href="#0" @click.prevent="open = !open; sidebarExpanded = true">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        <svg class="shrink-0 fill-current text-violet-500" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                          <path d="M5.936.278A7.983 7.983 0 0 1 8 0a8 8 0 1 1-8 8c0-.722.104-1.413.278-2.064a1 1 0 1 1 1.932.516A5.99 5.99 0 0 0 2 8a6 6 0 1 0 6-6c-.53 0-1.045.076-1.548.21A1 1 0 1 1 5.936.278Z" />
                          <path d="M6.068 7.482A2.003 2.003 0 0 0 8 10a2 2 0 1 0-.518-3.932L3.707 2.293a1 1 0 0 0-1.414 1.414l3.775 3.775Z" />
                        </svg>
                        <span class="text-sm font-medium ml-4 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200"><%= t("nav.dashboard") %></span>
                      </div>
                      <div class="flex shrink-0 ml-2 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200">
                        <svg class="w-3 h-3 shrink-0 ml-1 fill-current text-gray-400 dark:text-gray-500" :class="open ? 'rotate-180' : 'rotate-0'" viewBox="0 0 12 12">
                          <path d="M5.9 11.4L.5 6l1.4-1.4 4 4 4-4L11.3 6z" />
                        </svg>
                      </div>
                    </div>
                  </a>
                  <div class="lg:hidden lg:sidebar-expanded:block 2xl:block">
                    <ul class="pl-8 mt-1" :class="open ? 'block!' : 'hidden'">
                      <li class="mb-1 last:mb-0">
                        <%= link_to t("dashboard.nav.main", default: "Main"), dashboard_path, class: "block text-violet-500 transition truncate" %>
                      </li>
                      <li class="mb-1 last:mb-0">
                        <%= link_to t("dashboard.nav.analytics", default: "Analytics"), dashboard_analytics_path, class: "block text-gray-500/90 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition truncate" %>
                      </li>
                    </ul>
                  </div>
                </li>

                <li class="pl-4 pr-3 py-2 rounded-lg mb-0.5 last:mb-0" x-data="{ open: false }">
                  <a class="block text-gray-800 dark:text-gray-100 hover:text-gray-900 dark:hover:text-white truncate transition" href="#0" @click.prevent="open = !open; sidebarExpanded = true">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        <svg class="shrink-0 fill-current text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                          <path d="M9 6.855A3.502 3.502 0 0 0 8 0a3.5 3.5 0 0 0-1 6.855v1.656L5.534 9.65a3.5 3.5 0 1 0 1.229 1.578L8 10.267l1.238.962a3.5 3.5 0 1 0 1.229-1.578L9 8.511V6.855ZM6.5 3.5a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Zm4.803 8.095c.005-.005.01-.01.013-.016l.012-.016a1.5 1.5 0 1 1-.025.032ZM3.5 11c.474 0 .897.22 1.171.563l.013.016.013.017A1.5 1.5 0 1 1 3.5 11Z" />
                        </svg>
                        <span class="text-sm font-medium ml-4 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200"><%= t("dashboard.nav.expert_advisors", default: "Expert Advisors") %></span>
                      </div>
                      <div class="flex shrink-0 ml-2 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200">
                        <svg class="w-3 h-3 shrink-0 ml-1 fill-current text-gray-400 dark:text-gray-500" :class="open ? 'rotate-180' : 'rotate-0'" viewBox="0 0 12 12">
                          <path d="M5.9 11.4L.5 6l1.4-1.4 4 4 4-4L11.3 6z" />
                        </svg>
                      </div>
                    </div>
                  </a>
                  <div class="lg:hidden lg:sidebar-expanded:block 2xl:block">
                    <ul class="pl-8 mt-1 hidden" :class="open ? 'block!' : 'hidden'">
                      <% (@user_expert_advisors || []).each do |uea| %>
                        <li class="mb-1 last:mb-0">
                          <%= link_to uea.expert_advisor.name, dashboard_expert_advisor_docs_path(uea.expert_advisor, locale: I18n.locale), class: "block text-gray-500/90 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition truncate" %>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                </li>

                <li class="pl-4 pr-3 py-2 rounded-lg mb-0.5 last:mb-0">
                  <%= link_to dashboard_pricing_path, class: "block text-gray-800 dark:text-gray-100 hover:text-gray-900 dark:hover:text-white truncate transition" do %>
                    <div class="flex items-center">
                      <svg class="shrink-0 fill-current text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                        <path d="M3 14h10V4H3v10Zm10-12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10Zm-7 6h4v2H6V8Z" />
                      </svg>
                      <span class="text-sm font-medium ml-4 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200"><%= t("dashboard.nav.pricing", default: "Pricing") %></span>
                    </div>
                  <% end %>
                </li>

                <li class="pl-4 pr-3 py-2 rounded-lg mb-0.5 last:mb-0">
                  <%= link_to dashboard_billing_path, class: "block text-gray-800 dark:text-gray-100 hover:text-gray-900 dark:hover:text-white truncate transition" do %>
                    <div class="flex items-center">
                      <svg class="shrink-0 fill-current text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                        <path d="M1.5 1A1.5 1.5 0 0 0 0 2.5v6A1.5 1.5 0 0 0 1.5 10h.5v1.5a.5.5 0 0 0 .79.407L5.5 10H9A1.5 1.5 0 0 0 10.5 8.5v-6A1.5 1.5 0 0 0 9 1h-7.5Z" />
                        <path d="M12 3h2.5A1.5 1.5 0 0 1 16 4.5v7a1.5 1.5 0 0 1-1.5 1.5H11l-2.71 2.053A.5.5 0 0 1 7.5 14.61V13H7a1 1 0 0 1-1-1v-1h3.5A2.5 2.5 0 0 0 12 8.5v-5Z" />
                      </svg>
                      <span class="text-sm font-medium ml-4 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200"><%= t("dashboard.nav.billing", default: "Billing") %></span>
                    </div>
                  <% end %>
                </li>

                <li class="pl-4 pr-3 py-2 rounded-lg mb-0.5 last:mb-0">
                  <%= link_to dashboard_support_path, class: "block text-gray-800 dark:text-gray-100 hover:text-gray-900 dark:hover:text-white truncate transition" do %>
                    <div class="flex items-center">
                      <svg class="shrink-0 fill-current text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                        <path d="M8 1.5A6.5 6.5 0 0 0 1.5 8v4a.5.5 0 0 0 .5.5h3.5l2.56 2.561a.5.5 0 0 0 .853-.354V12.5H12a.5.5 0 0 0 .5-.5V8A6.5 6.5 0 0 0 8 1.5Zm0 1a5.5 5.5 0 0 1 5.5 5.5v3.5H8.914a.5.5 0 0 0-.5.5v2.293L6.707 12.5a.5.5 0 0 0-.354-.146H2V8A5.5 5.5 0 0 1 8 2.5Z" />
                      </svg>
                      <span class="text-sm font-medium ml-4 lg:opacity-0 lg:sidebar-expanded:opacity-100 2xl:opacity-100 duration-200"><%= t("dashboard.nav.support", default: "Support") %></span>
                    </div>
                  <% end %>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="relative flex flex-1 flex-col overflow-y-auto">
        <header class="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur border-b border-gray-200 dark:border-gray-800">
          <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 -mb-px">
              <div class="flex items-center gap-3">
                <button class="text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 lg:hidden" @click.stop="sidebarOpen = !sidebarOpen" aria-controls="sidebar" aria-expanded="sidebarOpen">
                  <span class="sr-only">Open sidebar</span>
                  <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M4 5h16M4 12h16M4 19h16" />
                  </svg>
                </button>
                <div>
                  <div class="text-sm text-gray-500 dark:text-gray-400"><%= t("app.name") %></div>
                  <div class="text-lg font-semibold text-gray-800 dark:text-gray-100"><%= t("app.tagline") %></div>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-gray-200/70 dark:bg-gray-800/80 rounded-full px-2 py-1">
                  <%= link_to "EN", url_for(locale: :en), class: "text-xs px-2 py-1 rounded-full #{I18n.locale == :en ? 'bg-violet-500 text-white' : 'text-gray-700 dark:text-gray-200 hover:text-violet-500'}" %>
                  <%= link_to "ES", url_for(locale: :es), class: "text-xs px-2 py-1 rounded-full #{I18n.locale == :es ? 'bg-violet-500 text-white' : 'text-gray-700 dark:text-gray-200 hover:text-violet-500'}" %>
                </div>
                <label class="relative inline-flex items-center h-6 rounded-full w-11 border border-gray-300 dark:border-gray-700 cursor-pointer px-1">
                  <span class="sr-only">Toggle theme</span>
                  <input type="checkbox" class="light-switch sr-only">
                  <span class="inline-block h-5 w-5 rounded-full bg-white dark:bg-gray-800 shadow transform transition"></span>
                </label>
                <% user_initial = (current_user.name.presence || current_user.email).to_s.first&.upcase %>
                <div class="relative" x-data="{ open: false }" @keydown.escape.stop="open=false" @click.outside="open=false">
                  <button class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-200" @click="open = !open">
                    <div class="w-8 h-8 rounded-full bg-violet-500 text-white flex items-center justify-center"><%= user_initial %></div>
                    <svg class="w-3 h-3 fill-current" viewBox="0 0 12 12">
                      <path d="M5.9 11.4 0 5.5l1.4-1.4 4.5 4.5 4.5-4.5L12 5.5z" />
                    </svg>
                  </button>
                  <div
                    class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-2 z-20"
                    x-show="open"
                    x-transition
                    x-cloak
                  >
                    <%= link_to t("dashboard.nav.profile", default: "Profile"), dashboard_path, class: "block px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md" %>
                    <%= link_to t("dashboard.nav.billing", default: "Billing"), dashboard_billing_path, class: "block px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md" %>
                    <%= link_to t("nav.sign_out"), destroy_user_session_path, data: { turbo_method: :delete }, class: "block px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md" %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <main class="grow px-4 sm:px-6 lg:px-8 py-8 lg:py-10">
          <%= yield %>
        </main>
      </div>
    </div>

    <%= javascript_importmap_tags %>
    <%= javascript_include_tag "mosaic/js/vendors/alpinejs.min", "data-turbo-track": "reload", defer: true %>
    <%= javascript_include_tag "mosaic/js/vendors/chart.js", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "mosaic/js/vendors/moment.js", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "mosaic/js/vendors/chartjs-adapter-moment.js", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "mosaic/js/dashboard-charts", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "mosaic/js/vendors/flatpickr", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "mosaic/js/flatpickr-init", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "mosaic/js/main", "data-turbo-track": "reload", defer: true %>
    <%= yield :scripts if content_for?(:scripts) %>
  </body>
</html>
