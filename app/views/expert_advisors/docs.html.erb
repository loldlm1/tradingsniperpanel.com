<% content_for :title, "#{@expert_advisor.name} Docs | #{t('app.short_name')}" %>
<% entry = @expert_advisor_entry %>
<% allowed_tier = Array(@expert_advisor.allowed_subscription_tiers).presence&.first || Billing::DashboardPlan::TIERS.first %>
<% cta_key = "#{allowed_tier}_monthly" %>
<% status = entry&.status || :locked %>
<% badge_class = case status
                when :active then "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-100"
                when :trial then "bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-100"
                else "bg-gray-100 text-gray-700 dark:bg-gray-700/60 dark:text-gray-200"
                end %>

<div class="mb-8 flex items-start justify-between flex-wrap gap-4">
  <div>
    <h1 class="text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-bold"><%= @expert_advisor.name %></h1>
    <p class="text-gray-600 dark:text-gray-300"><%= @expert_advisor.description %></p>
  </div>
  <% unless entry&.accessible %>
    <%= link_to t("dashboard.plans.cta.subscribe"), dashboard_plans_path(price_key: cta_key), class: "btn bg-gray-900 text-white hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-800 dark:hover:bg-white" %>
  <% end %>
</div>

<div class="grid gap-6 lg:grid-cols-4">
  <aside class="lg:col-span-1">
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5 sticky top-24 space-y-4">
      <div class="flex items-center justify-between gap-2">
        <div>
          <div class="text-sm font-semibold text-gray-800 dark:text-gray-100"><%= t("dashboard.license_key", default: "License Key") %></div>
          <% if entry&.expires_at.present? %>
            <div class="text-xs text-gray-500 dark:text-gray-400"><%= t("dashboard.expires_at", default: "Expires") %>: <%= l(entry.expires_at, format: :short_with_year) %></div>
          <% end %>
        </div>
        <span class="px-2 py-1 rounded-full text-xs font-semibold <%= badge_class %>"><%= status.to_s.humanize %></span>
      </div>
      <% if entry&.accessible && entry.license_key.present? %>
        <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-800 dark:text-gray-100">
          <span class="truncate"><%= entry.license_key %></span>
          <button
            type="button"
            class="text-violet-600 dark:text-violet-300 font-semibold"
            data-copy-text="<%= j entry.license_key %>"
            data-default-text="<%= t('dashboard.copy', default: t('dashboard.expert_advisors.copy_code', default: 'Copy')) %>"
            data-copied-text="<%= t('dashboard.copied', default: t('dashboard.expert_advisors.copied', default: 'Copied')) %>"
            onclick="copyToClipboard(this)"
          ><%= t("dashboard.copy", default: t("dashboard.expert_advisors.copy_code", default: "Copy")) %></button>
        </div>
      <% else %>
        <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.locked", default: "Subscribe to unlock this EA and receive your license.") %></p>
      <% end %>
      <%= render "expert_advisors/broker_accounts", broker_accounts: entry&.license&.broker_accounts if entry&.license.present? %>

      <% if @doc_headings.present? %>
        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
          <div class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-2"><%= t("dashboard.expert_advisors.toc", default: "On this page") %></div>
          <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-200">
            <% @doc_headings.each do |heading| %>
              <li>
                <a href="##{heading.id}" class="hover:text-violet-600 dark:hover:text-violet-300 block ml-<%= heading.level * 2 %>"><%= heading.text %></a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  </aside>

  <div class="lg:col-span-3 space-y-6">
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-sm font-semibold text-gray-800 dark:text-gray-100"><%= t("nav.docs") %></div>
          <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.docs_copy") %></p>
        </div>
        <span class="px-2 py-1 rounded-full text-[11px] font-semibold bg-gray-100 text-gray-700 dark:bg-gray-700/60 dark:text-gray-200"><%= t("dashboard.expert_advisors.pnl_soon") %></span>
      </div>
      <% if @markdown_html.present? %>
        <div class="ea-docs prose prose-sm max-w-none dark:prose-invert prose-headings:text-gray-100 prose-p:text-gray-200 prose-a:text-violet-400 prose-strong:text-gray-100 prose-code:text-gray-100">
          <%= @markdown_html %>
        </div>
      <% else %>
        <% docs = @expert_advisor.active_documents || {} %>
        <ul class="space-y-3 text-sm">
          <% docs.each do |key, url| %>
            <% path = dashboard_expert_advisor_download_path(@expert_advisor, doc_key: key) %>
            <li class="flex items-center justify-between">
              <div class="text-gray-700 dark:text-gray-200 capitalize"><%= key.to_s.tr("_", " ") %></div>
              <%= link_to t("dashboard.view_doc", default: "View"), path, class: "text-violet-600 hover:text-violet-800 dark:text-violet-300 dark:hover:text-violet-100" %>
            </li>
          <% end %>
        </ul>
      <% end %>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-sm font-semibold text-gray-800 dark:text-gray-100"><%= t("dashboard.expert_advisors.performance_title") %></div>
          <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.performance_copy") %></p>
        </div>
        <%= link_to t("dashboard.analytics.cta", default: "View analytics"), dashboard_analytics_path, class: "text-sm font-semibold text-violet-600 dark:text-violet-300 hover:text-violet-800 dark:hover:text-violet-100" %>
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-300"><%= t("dashboard.expert_advisors.performance_placeholder") %></div>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-3"><%= t("dashboard.nav.expert_advisors", default: "Expert Advisors") %></div>
      <div class="flex flex-wrap gap-2">
        <% (@accessible_eas || []).each_with_index do |e, idx| %>
          <%= link_to dashboard_expert_advisor_docs_path(e.expert_advisor, locale: I18n.locale), class: "px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm text-gray-800 dark:text-gray-100 hover:border-violet-400 dark:hover:border-violet-400 flex items-center gap-2" do %>
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700/60 dark:text-gray-100 text-[11px] font-semibold"><%= idx + 1 %></span>
            <span class="truncate"><%= e.expert_advisor.name %></span>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if @markdown_html.present? %>
  <%= javascript_tag nonce: content_security_policy_nonce do %>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.ea-docs pre').forEach(function(pre) {
        const button = document.createElement('button');
        button.className = 'absolute top-2 right-2 text-xs px-2 py-1 rounded bg-gray-900 text-white hover:bg-gray-800';
        button.textContent = '<%= j t("dashboard.expert_advisors.copy_code", default: "Copy") %>';
        button.addEventListener('click', function() {
          const code = pre.innerText;
          navigator.clipboard && navigator.clipboard.writeText(code);
          button.textContent = '<%= j t("dashboard.expert_advisors.copied", default: "Copied") %>';
          setTimeout(() => { button.textContent = '<%= j t("dashboard.expert_advisors.copy_code", default: "Copy") %>'; }, 1200);
        });
        pre.classList.add('relative');
        pre.appendChild(button);
      });
    });
  <% end %>
<% end %>
