<% content_for :title, "#{@expert_advisor.name} Docs | #{t('app.short_name')}" %>

<div class="mb-8 flex items-start justify-between flex-wrap gap-4">
  <div>
    <h1 class="text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-bold"><%= @expert_advisor.name %></h1>
    <p class="text-gray-600 dark:text-gray-300"><%= @expert_advisor.description %></p>
  </div>
  <% allowed_tier = Array(@expert_advisor.allowed_subscription_tiers).presence&.first || Billing::DashboardPlan::TIERS.first %>
  <% cta_key = "#{allowed_tier}_monthly" %>
  <% unless @expert_advisor_entry&.accessible %>
    <%= link_to t("dashboard.pricing.cta.subscribe"), dashboard_pricing_path(price_key: cta_key), class: "btn bg-gray-900 text-white hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-800 dark:hover:bg-white" %>
  <% end %>
</div>

<div class="grid gap-6 lg:grid-cols-3">
  <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-sm font-semibold text-gray-800 dark:text-gray-100"><%= t("dashboard.license_key", default: "License Key") %></div>
        <% if @expert_advisor_entry&.expires_at.present? %>
          <div class="text-xs text-gray-500 dark:text-gray-400"><%= t("dashboard.expires_at", default: "Expires") %>: <%= l(@expert_advisor_entry.expires_at, format: :short) %></div>
        <% end %>
      </div>
      <% status = @expert_advisor_entry&.status || :locked %>
      <% badge_class = case status
                      when :active then "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-100"
                      when :trial then "bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-100"
                      else "bg-gray-100 text-gray-700 dark:bg-gray-700/60 dark:text-gray-200"
                      end %>
      <span class="px-2 py-1 rounded-full text-xs font-semibold <%= badge_class %>"><%= status.to_s.humanize %></span>
    </div>
    <% if @expert_advisor_entry&.accessible && @expert_advisor_entry.license_key.present? %>
      <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-800 dark:text-gray-100">
        <span class="truncate"><%= @expert_advisor_entry.license_key %></span>
        <button type="button" class="text-violet-600 dark:text-violet-300 font-semibold" onclick="navigator.clipboard && navigator.clipboard.writeText('<%= j @expert_advisor_entry.license_key %>')"><%= t("dashboard.copy", default: "Copy") %></button>
      </div>
    <% else %>
      <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.locked", default: "Subscribe to unlock this EA and receive your license.") %></p>
    <% end %>
  </div>

  <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5 lg:col-span-2">
    <div class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-4"><%= t("nav.docs") %></div>
    <% if @markdown_html.present? %>
      <div class="prose prose-sm max-w-none dark:prose-invert prose-headings:text-gray-100 prose-p:text-gray-200 prose-a:text-violet-400 prose-strong:text-gray-100 prose-code:text-gray-100">
        <%= @markdown_html %>
      </div>
    <% else %>
      <% docs = @expert_advisor.active_documents || {} %>
      <ul class="space-y-3 text-sm">
        <% docs.each do |key, url| %>
          <% path = dashboard_expert_advisor_download_path(@expert_advisor, doc_key: key) %>
          <li class="flex items-center justify-between">
            <div class="text-gray-700 dark:text-gray-200 capitalize"><%= key.to_s.tr("_", " ") %></div>
            <%= link_to t("dashboard.view_doc", default: "View"), path, class: "text-violet-600 hover:text-violet-800 dark:text-violet-300 dark:hover:text-violet-100" %>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5 lg:col-span-3">
    <div class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-3"><%= t("dashboard.nav.expert_advisors", default: "Expert Advisors") %></div>
    <div class="flex flex-wrap gap-2">
      <% (@accessible_eas || []).each do |entry| %>
        <%= link_to entry.expert_advisor.name, dashboard_expert_advisor_docs_path(entry.expert_advisor, locale: I18n.locale), class: "px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm text-gray-800 dark:text-gray-100 hover:border-violet-400 dark:hover:border-violet-400" %>
      <% end %>
    </div>
  </div>
</div>
