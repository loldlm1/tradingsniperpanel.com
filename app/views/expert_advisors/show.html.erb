<% content_for :title, t("dashboard.expert_advisors.show_page_title", name: @expert_advisor.name, app: t("app.short_name")) %>
<% entry = @expert_advisor_entry %>
<% allowed_tier = Array(@expert_advisor.allowed_subscription_tiers).presence&.first || Billing::DashboardPlan::TIERS.first %>
<% cta_key = "#{allowed_tier}_monthly" %>
<% status = entry&.status || :locked %>
<% badge_class = case status
                when :active then "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-100"
                when :trial then "bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-100"
                else "bg-gray-100 text-gray-700 dark:bg-gray-700/60 dark:text-gray-200"
                end %>

<div class="mb-6 flex items-start justify-between flex-wrap gap-4">
  <div>
    <h1 class="text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-bold"><%= @expert_advisor.name %></h1>
    <p class="text-gray-600 dark:text-gray-300"><%= @expert_advisor.description %></p>
  </div>
  <div class="flex items-center gap-2">
    <span class="px-2 py-1 rounded-full text-xs font-semibold <%= badge_class %>"><%= status.to_s.humanize %></span>
    <% unless entry&.accessible %>
      <%= link_to t("dashboard.plans.cta.subscribe"), dashboard_plans_path(price_key: cta_key), class: "btn bg-gray-900 text-white hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-800 dark:hover:bg-white" %>
    <% end %>
  </div>
</div>

<div class="grid gap-6 lg:grid-cols-3">
  <div class="lg:col-span-2 space-y-6">
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-sm font-semibold text-gray-800 dark:text-gray-100"><%= t("dashboard.expert_advisors.guides_label") %></div>
          <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.preview_copy") %></p>
        </div>
        <%= link_to t("dashboard.expert_advisors.guides_cta"), dashboard_expert_advisor_guides_path(@expert_advisor, locale: I18n.locale), class: "text-sm font-semibold text-violet-600 dark:text-violet-300 hover:text-violet-800 dark:hover:text-violet-100" %>
      </div>
      <% if @guide_preview&.heading.present? || @guide_preview&.paragraph.present? %>
        <% if @guide_preview&.heading.present? %>
          <div class="text-lg font-semibold text-gray-800 dark:text-gray-100"><%= @guide_preview.heading %></div>
        <% end %>
        <% if @guide_preview&.paragraph.present? %>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-2"><%= truncate(@guide_preview.paragraph, length: 240) %></p>
        <% end %>
      <% else %>
        <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.preview_missing") %></p>
      <% end %>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-3"><%= t("dashboard.expert_advisors.details_title") %></div>
      <div class="grid gap-3 sm:grid-cols-2 text-sm">
        <div class="text-gray-600 dark:text-gray-300"><span class="text-xs uppercase text-gray-500 dark:text-gray-400 font-semibold block mb-1"><%= t("dashboard.expert_advisors.detail_type") %></span><%= @expert_advisor.ea_type.to_s.humanize %></div>
        <div class="text-gray-600 dark:text-gray-300"><span class="text-xs uppercase text-gray-500 dark:text-gray-400 font-semibold block mb-1"><%= t("dashboard.expert_advisors.detail_tier") %></span><%= Array(@expert_advisor.allowed_subscription_tiers).join(", ").presence || t("dashboard.expert_advisors.detail_tier_all") %></div>
      </div>
    </div>
  </div>

  <aside class="space-y-6">
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 p-5 space-y-4">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-800 dark:text-gray-100"><%= t("dashboard.expert_advisors.access_title") %></div>
        <span class="px-2 py-1 rounded-full text-xs font-semibold <%= badge_class %>"><%= status.to_s.humanize %></span>
      </div>

      <% if entry&.expires_at.present? %>
        <div class="text-xs text-gray-500 dark:text-gray-400"><%= t("dashboard.expires_at") %>: <%= l(entry.expires_at, format: :short_with_year) %></div>
      <% end %>

      <% if entry&.accessible && entry.license_key.present? %>
        <div>
          <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1"><%= t("dashboard.license_key") %></div>
          <div class="flex items-center gap-2 text-xs bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
            <span class="truncate"><%= entry.license_key %></span>
            <button
              type="button"
              class="text-violet-600 dark:text-violet-300 font-semibold"
              data-copy-text="<%= j entry.license_key %>"
              data-default-text="<%= t("dashboard.copy") %>"
              data-copied-text="<%= t("dashboard.copied") %>"
              onclick="copyToClipboard(this)"
            ><%= t("dashboard.copy") %></button>
          </div>
        </div>
      <% else %>
        <p class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.expert_advisors.locked") %></p>
      <% end %>

      <%= render "expert_advisors/broker_accounts", broker_accounts: entry&.license&.broker_accounts if entry&.license.present? %>

      <% if entry&.accessible && @expert_advisor.ea_files.attached? %>
        <%= link_to t("dashboard.expert_advisors.download_bundle"), dashboard_expert_advisor_download_path(@expert_advisor, locale: I18n.locale), class: "btn bg-gray-900 text-white hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-800 dark:hover:bg-white w-full" %>
      <% else %>
        <button class="btn bg-gray-900 text-white opacity-60 cursor-not-allowed dark:bg-gray-100 dark:text-gray-800 w-full" disabled><%= t("dashboard.expert_advisors.download_bundle") %></button>
        <% unless entry&.accessible %>
          <%= link_to t("dashboard.expert_advisors.unlock_cta"), dashboard_plans_path(price_key: cta_key), class: "text-sm font-semibold text-violet-600 dark:text-violet-300 hover:text-violet-800 dark:hover:text-violet-100 block text-center" %>
        <% else %>
          <p class="text-xs text-gray-500 dark:text-gray-400 text-center"><%= t("dashboard.expert_advisors.download_unavailable") %></p>
        <% end %>
      <% end %>
    </div>
  </aside>
</div>
