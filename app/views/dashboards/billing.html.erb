<% content_for :title, "#{t('dashboard.nav.billing')} | #{t('app.short_name')}" %>

<% default_pm = @pay_customer&.default_payment_method %>
<% pm_brand = default_pm&.brand || default_pm&.card_type || default_pm&.type %>
<% pm_last4 = default_pm&.last4 %>
<% plan = @plan_context || {} %>
<% plan_name = plan[:current_tier] ? t("dashboard.plans.tiers.#{plan[:current_tier]}.name", default: plan[:current_tier].to_s.humanize) : nil %>
<% interval_key = plan[:current_interval] == "annual" ? "annually" : plan[:current_interval] %>
<% interval_label = interval_key.present? ? t("dashboard.plans.toggle.#{interval_key}", default: interval_key.to_s.humanize) : nil %>
<% summary_text = if plan_name.present? && interval_label.present?
                    t("dashboard.billing.summary", plan_name: plan_name, interval: interval_label)
                  else
                    t("dashboard.billing.no_plan_summary")
                  end %>
<% invoice_labeler = Billing::InvoicePlanLabeler.new %>
<% cancel_confirm = t("dashboard.billing.cancel_confirm") %>

<div class="bg-white dark:bg-gray-800 shadow-xs rounded-xl mb-8">
  <div class="p-6 space-y-6">
    <div>
      <h2 class="text-2xl text-gray-800 dark:text-gray-100 font-bold mb-4"><%= t("dashboard.billing.title") %></h2>
      <div class="text-sm"><%= summary_text %></div>
    </div>

    <section>
      <h3 class="text-xl leading-snug text-gray-800 dark:text-gray-100 font-bold mb-1"><%= t("dashboard.billing.info_title") %></h3>
      <ul>
        <li class="md:flex md:justify-between md:items-center py-3 border-b border-gray-200 dark:border-gray-700/60">
          <div class="text-sm text-gray-800 dark:text-gray-100 font-medium"><%= t("dashboard.billing.payment_method_label") %></div>
          <div class="text-sm text-gray-600 dark:text-gray-400 ml-4">
            <% payment_method_text = if default_pm.present?
                                      t("dashboard.billing.card_ending", brand: pm_brand&.upcase || t("dashboard.billing.card"), last4: pm_last4 || t("dashboard.billing.last4_placeholder"))
                                    else
                                      t("dashboard.billing.no_payment_method")
                                    end %>
            <span class="mr-3"><%= payment_method_text %></span>
            <%= button_to dashboard_billing_portal_path, method: :post, class: "font-medium text-violet-500 hover:text-violet-600 dark:hover:text-violet-400", data: { loading_target: true }, form: { class: "inline" } do %>
              <%= loading_label(t("dashboard.billing.edit_action"), loading_text: t("loading.default")) %>
            <% end %>
          </div>
        </li>
        <li class="md:flex md:justify-between md:items-center py-3 border-b border-gray-200 dark:border-gray-700/60">
          <div class="text-sm text-gray-800 dark:text-gray-100 font-medium"><%= t("dashboard.billing.billing_interval_label") %></div>
          <div class="text-sm text-gray-600 dark:text-gray-400 ml-4">
            <span class="mr-3"><%= interval_label || t("dashboard.billing.placeholder") %></span>
            <%= link_to dashboard_plans_path, class: "font-medium text-violet-500 hover:text-violet-600 dark:hover:text-violet-400", data: { loading_target: true } do %>
              <%= loading_label(t("dashboard.billing.edit_action"), loading_text: t("loading.default")) %>
            <% end %>
          </div>
        </li>
        <li class="md:flex md:justify-between md:items-center py-3 border-b border-gray-200 dark:border-gray-700/60">
          <div class="text-sm text-gray-800 dark:text-gray-100 font-medium"><%= t("dashboard.plan_card.plan_key") %></div>
          <div class="text-sm text-gray-600 dark:text-gray-400 ml-4">
            <span class="mr-3"><%= @subscription&.processor_plan.presence || t("dashboard.billing.placeholder") %></span>
            <%= link_to dashboard_plans_path, class: "font-medium text-violet-500 hover:text-violet-600 dark:hover:text-violet-400", data: { loading_target: true } do %>
              <%= loading_label(t("dashboard.billing.edit_action"), loading_text: t("loading.default")) %>
            <% end %>
          </div>
        </li>
        <li class="md:flex md:justify-between md:items-center py-3 border-b border-gray-200 dark:border-gray-700/60">
          <div class="text-sm text-gray-800 dark:text-gray-100 font-medium"><%= t("dashboard.billing.renews_on_label") %></div>
          <div class="text-sm text-gray-600 dark:text-gray-400 ml-4">
            <% renewal_text = if @subscription.respond_to?(:current_period_end) && @subscription.current_period_end.present?
                                l(@subscription.current_period_end.to_date)
                              else
                                t("dashboard.billing.placeholder")
                              end %>
            <span class="mr-3"><%= renewal_text %></span>
          </div>
        </li>
        <li class="md:flex md:justify-between md:items-center py-3 border-b border-gray-200 dark:border-gray-700/60">
          <div class="text-sm text-gray-800 dark:text-gray-100 font-medium"><%= t("dashboard.billing.billing_email_label") %></div>
          <div class="text-sm text-gray-600 dark:text-gray-400 ml-4">
            <span class="mr-3"><%= current_user&.email.presence || t("dashboard.billing.placeholder") %></span>
            <%= link_to dashboard_settings_path, class: "font-medium text-violet-500 hover:text-violet-600 dark:hover:text-violet-400", data: { loading_target: true } do %>
              <%= loading_label(t("dashboard.billing.edit_action"), loading_text: t("loading.default")) %>
            <% end %>
          </div>
        </li>
      </ul>
    </section>

    <section>
      <h3 class="text-xl leading-snug text-gray-800 dark:text-gray-100 font-bold mb-1"><%= t("dashboard.billing.cancel_title") %></h3>
      <div class="text-sm mb-3"><%= t("dashboard.billing.cancel_copy") %></div>
      <% if @subscription.present? %>
        <% if @subscription.ends_at.present? %>
          <div class="text-sm text-amber-600 dark:text-amber-300 mb-3">
            <%= t("dashboard.billing.cancel_scheduled", date: l(@subscription.ends_at.to_date)) %>
          </div>
          <button class="btn bg-gray-900 text-gray-100 opacity-60 cursor-not-allowed dark:bg-gray-100 dark:text-gray-800 w-full sm:w-auto" disabled>
            <%= t("dashboard.billing.cancel_action") %>
          </button>
        <% else %>
          <%= button_to dashboard_cancel_subscription_path,
                        method: :post,
                        class: "btn bg-gray-900 text-gray-100 hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-800 dark:hover:bg-white w-full sm:w-auto",
                        data: { loading_target: true, confirm_message: cancel_confirm },
                        form: { class: "inline" } do %>
            <%= loading_label(t("dashboard.billing.cancel_action"), loading_text: t("loading.default")) %>
          <% end %>
        <% end %>
      <% else %>
        <div class="text-sm text-gray-500 dark:text-gray-400"><%= t("dashboard.billing.cancel_unavailable") %></div>
      <% end %>
      <div class="text-xs text-gray-500 dark:text-gray-400 mt-3"><%= t("dashboard.billing.cancel_disclaimer") %></div>
    </section>

    <section>
      <h3 class="text-xl leading-snug text-gray-800 dark:text-gray-100 font-bold mb-1"><%= t("dashboard.billing.invoices_title") %></h3>
      <div class="text-sm mb-4"><%= t("dashboard.billing.invoices_copy") %></div>
      <table class="table-auto w-full dark:text-gray-400">
        <thead class="text-xs uppercase text-gray-400 dark:text-gray-500">
          <tr class="flex flex-wrap md:table-row md:flex-no-wrap">
            <th class="w-full block md:w-auto md:table-cell py-2">
              <div class="font-semibold text-left"><%= t("dashboard.billing.invoice_year") %></div>
            </th>
            <th class="w-full hidden md:w-auto md:table-cell py-2">
              <div class="font-semibold text-left"><%= t("dashboard.billing.invoice_plan") %></div>
            </th>
            <th class="w-full hidden md:w-auto md:table-cell py-2">
              <div class="font-semibold text-left"><%= t("dashboard.billing.invoice_amount") %></div>
            </th>
            <th class="w-full hidden md:w-auto md:table-cell py-2">
              <div class="font-semibold text-left"><%= t("dashboard.billing.invoice_status") %></div>
            </th>
            <th class="w-full hidden md:w-auto md:table-cell py-2">
              <div class="font-semibold text-right"><%= t("dashboard.billing.invoice_receipt") %></div>
            </th>
          </tr>
        </thead>
        <tbody class="text-sm">
          <% @invoices.each do |invoice| %>
            <% amount = invoice.amount&.to_f ? invoice.amount.to_f / 100.0 : nil %>
            <% status_label = invoice.respond_to?(:data) ? invoice.data&.dig("status") : nil %>
            <% status_label ||= invoice.respond_to?(:object) ? invoice.object&.dig("status") : nil %>
            <% status_label ||= invoice.amount_refunded.to_i.positive? ? "refunded" : "succeeded" %>
            <% badge_class = status_label == "succeeded" ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-100" : "bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-100" %>
            <% invoice_label = invoice_labeler.label_for(invoice, fallback_label: t("dashboard.billing.placeholder")) %>
            <tr class="flex flex-wrap md:table-row md:flex-no-wrap border-b border-gray-200 dark:border-gray-700/60 py-2 md:py-0">
              <td class="w-full block md:w-auto md:table-cell py-0.5 md:py-2">
                <div class="text-left font-medium text-gray-800 dark:text-gray-100"><%= invoice.created_at&.year || t("dashboard.billing.placeholder") %></div>
              </td>
              <td class="w-full block md:w-auto md:table-cell py-0.5 md:py-2">
                <div class="text-left"><%= invoice_label %></div>
              </td>
              <td class="w-full block md:w-auto md:table-cell py-0.5 md:py-2">
                <div class="text-left font-medium"><%= amount ? number_to_currency(amount) : t("dashboard.billing.placeholder") %></div>
              </td>
              <td class="w-full block md:w-auto md:table-cell py-0.5 md:py-2">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold <%= badge_class %>"><%= status_label %></span>
              </td>
              <td class="w-full block md:w-auto md:table-cell py-0.5 md:py-2">
                <div class="text-right flex items-center md:justify-end">
                  <% receipt = invoice.respond_to?(:receipt_url) ? invoice.receipt_url : nil %>
                  <% if receipt.present? %>
                    <%= link_to t("dashboard.billing.invoice_view"), receipt, target: "_blank", rel: "noopener", class: "font-medium text-violet-500 hover:text-violet-600 dark:hover:text-violet-400" %>
                  <% else %>
                    <span class="text-gray-500 dark:text-gray-400"><%= t("dashboard.billing.placeholder") %></span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
          <% if @invoices.empty? %>
            <tr class="flex flex-wrap md:table-row md:flex-no-wrap border-b border-gray-200 dark:border-gray-700/60 py-2 md:py-0">
              <td class="w-full block md:w-auto md:table-cell py-2" colspan="5">
                <div class="text-center text-gray-500 dark:text-gray-400"><%= t("dashboard.billing.no_invoices") %></div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </section>
  </div>
</div>
